"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[86301],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var s=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,s,o=function(e,t){if(null==e)return{};var n,s,o={},i=Object.keys(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=s.createContext({}),c=function(e){var t=s.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},d=function(e){var t=c(e.components);return s.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},u=s.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),u=c(n),m=o,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||i;return n?s.createElement(h,a(a({ref:t},d),{},{components:n})):s.createElement(h,a({ref:t},d))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,a=new Array(i);a[0]=u;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:o,a[1]=r;for(var c=2;c<i;c++)a[c]=n[c];return s.createElement.apply(null,a)}return s.createElement.apply(null,n)}u.displayName="MDXCreateElement"},37066:(e,t,n)=>{n.r(t),n.d(t,{frontMatter:()=>r,contentTitle:()=>l,metadata:()=>c,toc:()=>d,default:()=>u});var s=n(87462),o=n(63366),i=(n(67294),n(3905)),a=["components"],r={id:"the-basics-session",title:"Session",original_id:"the-basics-session"},l=void 0,c={unversionedId:"the-basics-session",id:"version-1.0.5/the-basics-session",isDocsHomePage:!1,title:"Session",description:"Introduction",source:"@site/versioned_docs/version-1.0.5/the-basics-session.md",sourceDirName:".",slug:"/the-basics-session",permalink:"/docs/1.0.5/the-basics-session",editUrl:"https://github.com/Yoctol/bottender/edit/master/docs/versioned_docs/version-1.0.5/the-basics-session.md",tags:[],version:"1.0.5",lastUpdatedBy:"\u5433\u6771\u66c4 Wu, Dung-Ie",lastUpdatedAt:1636542901,formattedLastUpdatedAt:"11/10/2021",frontMatter:{id:"the-basics-session",title:"Session",original_id:"the-basics-session"},sidebar:"version-1.0.5/docs",previous:{title:"Chain of Responsibility",permalink:"/docs/1.0.5/the-basics-chain"},next:{title:"Error Handling",permalink:"/docs/1.0.5/the-basics-errors"}},d=[{value:"Introduction",id:"introduction",children:[],level:2},{value:"Session State",id:"session-state",children:[{value:"A Counting Bot Example",id:"a-counting-bot-example",children:[],level:3},{value:"Adding State to the Conversation",id:"adding-state-to-the-conversation",children:[],level:3},{value:"State Updates are Merged",id:"state-updates-are-merged",children:[],level:3},{value:"Debug State in Console Mode",id:"debug-state-in-console-mode",children:[],level:3}],level:2},{value:"Session Id",id:"session-id",children:[{value:"Usage",id:"usage",children:[],level:3},{value:"Session Key of LINE",id:"session-key-of-line",children:[],level:3},{value:"Session Key in Telegram",id:"session-key-in-telegram",children:[],level:3},{value:"Session Key in Messenger",id:"session-key-in-messenger",children:[],level:3},{value:"Session Key in Slack",id:"session-key-in-slack",children:[],level:3},{value:"Session Key in Viper",id:"session-key-in-viper",children:[],level:3}],level:2},{value:"Session Storage",id:"session-storage",children:[{value:"Configuring Session Driver",id:"configuring-session-driver",children:[],level:3},{value:"Using Different Session Driver Based on NODE_ENV",id:"using-different-session-driver-based-on-node_env",children:[],level:3},{value:"Setting the Session Expiration Time",id:"setting-the-session-expiration-time",children:[],level:3}],level:2}],p={toc:d};function u(e){var t=e.components,n=(0,o.Z)(e,a);return(0,i.kt)("wrapper",(0,s.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"Bottender provides a mechanism for you to recognize each conversation and store temporary data on ecah conversation. just like session of the web server."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/docs/1.0.5/the-basics-session#session-state"},"Session state"),": store and retrieve data on each conversation"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/docs/1.0.5/the-basics-session#session-id"},"Session id"),": a identifier to recognize each conversation"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/docs/1.0.5/the-basics-session#session-storage"},"Session storage"),": specify what kind of storage you want to use")),(0,i.kt)("h2",{id:"session-state"},"Session State"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"State")," is widely used in flow control of daily mahcines, e.g. traffic light. The change of state is in response to external inputs and/or conditions is satisfied. For example, a green traffic light (a state) changes to yellow traffic light after 60 sec (a satisfied time condition)."),(0,i.kt)("h3",{id:"a-counting-bot-example"},"A Counting Bot Example"),(0,i.kt)("p",null,"Considering a couting bot which responds the number of message events it received, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"You > Hi\nBot > Count: 1\nYou > Hi\nBot > Count: 2\n")),(0,i.kt)("p",null,"In this section, we will explain how to use state correctly to build a counter. It begins with a count state variable, which will be updated when the bot receives an event."),(0,i.kt)("p",null,"Let's start with a static action like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"async function EventCount(context) {\n  await context.sendText('Count: 1');\n}\n")),(0,i.kt)("h3",{id:"adding-state-to-the-conversation"},"Adding State to the Conversation"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Set initial state in ",(0,i.kt)("inlineCode",{parentName:"li"},"bottender.config.js")," file:")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"module.exports = {\n  initialState: {\n    count: 0,\n  },\n};\n")),(0,i.kt)("p",null,"After adding this, Bottender will set initial state to this object for the new conversation session."),(0,i.kt)("ol",{start:2},(0,i.kt)("li",{parentName:"ol"},"Access state value using ",(0,i.kt)("inlineCode",{parentName:"li"},"context.state"),":")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"async function EventCount(context) {\n  const count = context.state.count + 1;\n  await context.sendText(`Count: ${count}`);\n}\n")),(0,i.kt)("p",null,"Even though we use state variable to render the message content, it always gets ",(0,i.kt)("inlineCode",{parentName:"p"},"Count: 1")," as result. That's why step 3 is necessary."),(0,i.kt)("ol",{start:3},(0,i.kt)("li",{parentName:"ol"},"Set state value using ",(0,i.kt)("inlineCode",{parentName:"li"},"context.setState()"),":")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"async function EventCount(context) {\n  const count = context.state.count + 1;\n\n  context.setState({\n    count,\n  });\n\n  await context.sendText(`Count: ${count}`);\n}\n")),(0,i.kt)("p",null,"Then it works as expected."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("strong",{parentName:"p"},"Note:")," don't modify state directly using ",(0,i.kt)("inlineCode",{parentName:"p"},"this.state.stateKey = stateValue;"),", it may cause unexpected behavior in the future.")),(0,i.kt)("h3",{id:"state-updates-are-merged"},"State Updates are Merged"),(0,i.kt)("p",null,"When you call ",(0,i.kt)("inlineCode",{parentName:"p"},"setState()"),", Bottender shallow merges the object you provide into the current state."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"context.state; // { count: 1 }\n\ncontext.setState({\n  myObject: {},\n});\n\ncontext.state; // { count: 1, myObject: {} }\n")),(0,i.kt)("p",null,"But if you want to do a deeper merge, you need to do it explicitly:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"context.setState({\n  myObject: {\n    ...context.myObject,\n    key: value,\n  },\n});\n")),(0,i.kt)("h3",{id:"debug-state-in-console-mode"},"Debug State in Console Mode"),(0,i.kt)("p",null,"In ",(0,i.kt)("a",{parentName:"p",href:"/docs/1.0.5/the-basics-console-mode"},'"Console Mode"'),", you can leverage the convenient built-in command - ",(0,i.kt)("inlineCode",{parentName:"p"},"/state")," to help you debugging you state transition:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"You > /state\n")),(0,i.kt)("p",null,"This commmand formats the state with ",(0,i.kt)("inlineCode",{parentName:"p"},"JSON.stringify()")," and send the result as a bot message to you:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'Bot > { "count": 1 }\n')),(0,i.kt)("h2",{id:"session-id"},"Session Id"),(0,i.kt)("p",null,"Bottender provides a consistent interface ",(0,i.kt)("inlineCode",{parentName:"p"},"session.id")," as a unique identifier for all platform in all kinds of request."),(0,i.kt)("h3",{id:"usage"},"Usage"),(0,i.kt)("p",null,"The following code is a demo to reply session.id to user:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"module.exports = async function App(context) {\n  await context.sendText(`session.platform: ${context.session.platform}`);\n  await context.sendText(`session.id: ${context.session.id}`);\n};\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"session.id")," includes the platform name and channel id to avoid any confiction when a bot connect to multiple platform."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yoctol/bottender/blob/master/packages/bottender/src/bot/Bot.ts#L185"},"The defination of ",(0,i.kt)("inlineCode",{parentName:"a"},"session.id"))," in Bottender is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"sessionId = `${platform}:${sessionKey}`\n")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"platform")," is the platform name, the ",(0,i.kt)("inlineCode",{parentName:"p"},"sessionKey")," come from different sources in different situations."),(0,i.kt)("h3",{id:"session-key-of-line"},"Session Key of LINE"),(0,i.kt)("p",null,"there are 3 type of source in LINE playform defined in ",(0,i.kt)("a",{parentName:"p",href:"https://developers.line.biz/en/reference/messaging-api/#common-properties"},"the LINE official document"),", Source user, Source group and Source room."),(0,i.kt)("p",null,"if a request come from source user, then the sessionKey will be source.userId, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"line:U4af4980629...\n")),(0,i.kt)("p",null,"if a request come from source group, then the sessionKey will be source.groupId, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"line:Ca56f94637c...\n")),(0,i.kt)("p",null,"if a request come from source room, then the sessionKey will be source.roomId, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"line:Ra8dbf4673c...\n")),(0,i.kt)("p",null,"you can read ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yoctol/bottender/blob/master/packages/bottender/src/bot/LineConnector.ts#L115"},"the implement detail here")),(0,i.kt)("h3",{id:"session-key-in-telegram"},"Session Key in Telegram"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"sessionKey")," represent for the ",(0,i.kt)("inlineCode",{parentName:"p"},"chat.id")," in Telegram platform. The principal is the same as the LINE platform, but the implement is more complicated."),(0,i.kt)("p",null,"this is an example of ",(0,i.kt)("inlineCode",{parentName:"p"},"session.id"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"telegram:16423...\n")),(0,i.kt)("p",null,"you can read ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yoctol/bottender/blob/master/packages/bottender/src/bot/TelegramConnector.ts#L55"},"the implement detail here")),(0,i.kt)("h3",{id:"session-key-in-messenger"},"Session Key in Messenger"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"sessionKey")," represent for the ",(0,i.kt)("inlineCode",{parentName:"p"},"recipient.id")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"sender.id")," in Slack platform."),(0,i.kt)("p",null,"you can read ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yoctol/bottender/blob/master/packages/bottender/src/bot/MessengerConnector.ts#L233"},"the implement detail here")),(0,i.kt)("h3",{id:"session-key-in-slack"},"Session Key in Slack"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"sessionKey")," represent for the ",(0,i.kt)("inlineCode",{parentName:"p"},"channel.id")," in Slack platform."),(0,i.kt)("p",null,"you can read ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yoctol/bottender/blob/master/packages/bottender/src/bot/SlackConnector.ts#L117"},"the implement detail here")),(0,i.kt)("h3",{id:"session-key-in-viper"},"Session Key in Viper"),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"sessionKey")," represent for the ",(0,i.kt)("inlineCode",{parentName:"p"},"user.id")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"sender.id")," in Slack platform."),(0,i.kt)("p",null,"you can read ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Yoctol/bottender/blob/master/packages/bottender/src/bot/ViberConnector.ts#L66"},"the implement detail here")),(0,i.kt)("h2",{id:"session-storage"},"Session Storage"),(0,i.kt)("p",null,"Since HTTP driven applications are stateless, the mission of sessions is to store context of users during conversations. Bottender offers a variety of session drivers right out of the box, e.g. memory, file, redis, and mongo. These drivers could be accessed through an expressive, unified API."),(0,i.kt)("p",null,"From connectors, the information of session could be accessed, e.g. session id,\nplus, whether the session is between a bot and single user, or between a bot and a group of users. One bot could support multiple messaging platforms at once, and one connector refers to one messaging platform."),(0,i.kt)("p",null,"You can specify an explicit session expiration time to reset the state. It makes a bot more human-like by forgetting (initializing) the state after conversation has been inactive for a while"),(0,i.kt)("h3",{id:"configuring-session-driver"},"Configuring Session Driver"),(0,i.kt)("p",null,"Session driver can be set by ",(0,i.kt)("inlineCode",{parentName:"p"},"session.driver")," value in the ",(0,i.kt)("inlineCode",{parentName:"p"},"bottender.config.js")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// bottender.config.js\n\nmodule.exports = {\n  session: {\n    driver: 'memory',\n    stores: {\n      memory: {\n        maxSize: 500,\n      },\n      file: {\n        dirname: '.session',\n      },\n      redis: {\n        port: 6379,\n        host: '127.0.0.1',\n        password: 'auth',\n        db: 0,\n      },\n      mongo: {\n        url: 'mongodb://localhost:27017',\n        collectionName: 'sessions',\n      },\n    },\n  },\n};\n")),(0,i.kt)("p",null,"The four valid drivers are as follows:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"memory")," - sessions are stored in memory with ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/isaacs/node-lru-cache"},"LRU cache")," and not persistent."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"file")," - sessions are stored in files placed in ",(0,i.kt)("inlineCode",{parentName:"li"},".session")," directory by default."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"redis")," - sessions are stored in a ",(0,i.kt)("a",{parentName:"li",href:"https://redis.io/"},"redis")," database."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"mongo")," - sessions are stored in a ",(0,i.kt)("a",{parentName:"li",href:"https://www.mongodb.com/"},"mongo")," database.")),(0,i.kt)("h3",{id:"using-different-session-driver-based-on-node_env"},"Using Different Session Driver Based on NODE_ENV"),(0,i.kt)("p",null,"It is recommended to use memory as the session driver in the development for shorter iteration. By restarting the process, the session store could be reset completely."),(0,i.kt)("p",null,"You can determine which session driver to use in the development or production by env variable:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// bottender.config.js\n\nmodule.exports = {\n  session: {\n    driver: process.env.NODE_ENV === 'production' ? 'mongo' : 'memory',\n    // ...\n  },\n};\n")),(0,i.kt)("h3",{id:"setting-the-session-expiration-time"},"Setting the Session Expiration Time"),(0,i.kt)("p",null,"By default, the sessions stored by Bottender never expire. To set explicit session expiration time, add the ",(0,i.kt)("inlineCode",{parentName:"p"},"session.expiresIn")," setting in your ",(0,i.kt)("inlineCode",{parentName:"p"},"bottender.config.js")," file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"// bottender.config.js\n\nmodule.exports = {\n  session: {\n    driver: 'memory',\n    expiresIn: 15, // 15 minutes\n    // ...\n  },\n};\n")),(0,i.kt)("p",null,"With settings above, the user will get a new session and new ",(0,i.kt)("a",{parentName:"p",href:"/docs/1.0.5/the-basics-session#session-state"},"session state")," after inactive for 15 minutes."))}u.isMDXComponent=!0}}]);